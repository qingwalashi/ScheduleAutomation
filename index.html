<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡è®¢é˜…ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- æ·»åŠ  js-yaml åº“ç”¨äºè§£æ YAML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">æœåŠ¡è®¢é˜…ç®¡ç†</h1>
        
        <!-- åŸŸååˆ°æœŸä¿¡æ¯ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">åŸŸååˆ°æœŸä¿¡æ¯</h2>
            <div class="space-y-4">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åŸŸå</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ°æœŸæ—¥æœŸ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SSLåˆ°æœŸæ—¥æœŸ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="domainTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- è®¢é˜…æœåŠ¡ä¿¡æ¯ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">è®¢é˜…æœåŠ¡ä¿¡æ¯</h2>
            <div class="space-y-4">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœåŠ¡åç§°</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ°æœŸæ—¥æœŸ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è´¹ç”¨</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‰©ä½™|è¶…æœŸå¤©æ•°</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ†ç±»</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="subscriptionTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-right">
                    <p class="text-lg font-semibold text-gray-700">æ€»è´¹ç”¨ï¼š<span id="totalCost" class="text-blue-600">Â¥0.00</span></p>
                </div>
            </div>
        </div>

        <!-- ICS è®¢é˜…åœ°å€ -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">ICS è®¢é˜…åœ°å€</h2>
            <div class="space-y-4">
                <div class="flex flex-col space-y-4">
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-700">åŸŸååˆ°æœŸæé†’ï¼š</span>
                        <input type="text" id="domainIcsUrl" readonly 
                               class="flex-1 px-4 py-2 border rounded-lg bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="copyIcsUrl('domainIcsUrl')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            å¤åˆ¶
                        </button>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-700">è®¢é˜…æœåŠ¡æé†’ï¼š</span>
                        <input type="text" id="subscriptionIcsUrl" readonly 
                               class="flex-1 px-4 py-2 border rounded-lg bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="copyIcsUrl('subscriptionIcsUrl')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            å¤åˆ¶
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è®¡ç®—å‰©ä½™æˆ–è¶…æœŸå¤©æ•°
        function calculateDaysRemaining(expiryDate) {
            if (!expiryDate || expiryDate === 'permanent') {
                return null;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiry = new Date(expiryDate);
            expiry.setHours(0, 0, 0, 0);
            
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // è·å–å¤©æ•°æ˜¾ç¤ºæ ·å¼
        function getDaysDisplayStyle(days) {
            if (days === null) return 'bg-gray-100 text-gray-800';
            if (days < 0) return 'bg-red-100 text-red-800'; // å·²è¿‡æœŸ
            if (days <= 30) return 'bg-orange-100 text-orange-800'; // 30å¤©å†…
            return 'bg-green-100 text-green-800'; // 30å¤©ä»¥ä¸Š
        }

        // è·å–å¤©æ•°æ˜¾ç¤ºæ–‡æœ¬
        function getDaysDisplayText(days) {
            if (days === null) return '-';
            return `${Math.abs(days)}å¤©`;
        }

        // åˆ†ç±» emoji æ˜ å°„
        const categoryEmojis = {
            'è´­ç‰©': 'ğŸ›ï¸',
            'æ•ˆç‡å·¥å…·': 'âš¡',
            'AIæœåŠ¡': 'ğŸ¤–',
            'ç½‘ç»œæœåŠ¡': 'ğŸŒ'
        };

        // åŠ è½½ YAML æ–‡ä»¶
        async function loadYamlFile(path) {
            try {
                const response = await fetch(path);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const yamlText = await response.text();
                return jsyaml.load(yamlText);
            } catch (error) {
                console.error('Error loading YAML file:', error);
                return null;
            }
        }

        // æ¸²æŸ“åŸŸåè¡¨æ ¼
        function renderDomainTable(domainConfig) {
            const tbody = document.getElementById('domainTableBody');
            tbody.innerHTML = '';

            if (!domainConfig || !domainConfig.domains_expiry) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">åŠ è½½å¤±è´¥</td></tr>';
                return;
            }

            for (const domain in domainConfig.domains_expiry) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <a href="https://${domain}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">${domain}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${domainConfig.domains_expiry[domain]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${domainConfig.domains_ssl_expiry[domain] || '-'}</td>
                `;
                tbody.appendChild(row);
            }
        }

        // æ¸²æŸ“è®¢é˜…æœåŠ¡è¡¨æ ¼
        function renderSubscriptionTable(subscriptionConfig) {
            const tbody = document.getElementById('subscriptionTableBody');
            tbody.innerHTML = '';

            if (!subscriptionConfig || !subscriptionConfig.subscription_services) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">åŠ è½½å¤±è´¥</td></tr>';
                return;
            }

            // æŒ‰åˆ†ç±»æ’åºæœåŠ¡
            const services = Object.entries(subscriptionConfig.subscription_services)
                .sort((a, b) => {
                    // é¦–å…ˆæŒ‰åˆ†ç±»æ’åº
                    const categoryCompare = a[1].category.localeCompare(b[1].category);
                    if (categoryCompare !== 0) return categoryCompare;
                    // ç„¶åæŒ‰åç§°æ’åº
                    return a[1].name.localeCompare(b[1].name);
                });

            let totalCost = 0;
            let currentCategory = '';

            for (const [id, service] of services) {
                // å¦‚æœæ˜¯æ–°çš„åˆ†ç±»ï¼Œæ·»åŠ åˆ†ç±»æ ‡é¢˜è¡Œ
                if (service.category !== currentCategory) {
                    currentCategory = service.category;
                    const categoryRow = document.createElement('tr');
                    categoryRow.innerHTML = `
                        <td colspan="6" class="px-6 py-3 bg-gray-100 text-sm font-medium text-gray-700">${service.category}</td>
                    `;
                    tbody.appendChild(categoryRow);
                }

                const row = document.createElement('tr');
                const daysRemaining = calculateDaysRemaining(service.expiry_date);
                const daysStyle = getDaysDisplayStyle(daysRemaining);
                const daysText = getDaysDisplayText(daysRemaining);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${service.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${service.expiry_date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Â¥${service.cost.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${service.status === 'è®¢é˜…ä¸­' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${service.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${daysStyle}">
                            ${daysText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${service.category}</td>
                `;
                tbody.appendChild(row);

                // ç´¯åŠ æ€»è´¹ç”¨
                if (service.status === 'è®¢é˜…ä¸­') {
                    totalCost += service.cost;
                }
            }

            // æ›´æ–°æ€»è´¹ç”¨æ˜¾ç¤º
            document.getElementById('totalCost').textContent = `Â¥${totalCost.toFixed(2)}`;
        }

        // å¤åˆ¶ ICS URL
        function copyIcsUrl(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            document.execCommand('copy');
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'å·²å¤åˆ¶';
            btn.classList.add('bg-green-500');
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('bg-green-500');
            }, 2000);
        }

        // è·å–å½“å‰åŸŸå
        function getCurrentDomain() {
            return window.location.hostname || 'localhost';
        }

        // è·å– ICS URL
        function getIcsUrl(filename) {
            const domain = getCurrentDomain();
            const protocol = window.location.protocol;
            const port = window.location.port ? `:${window.location.port}` : '';
            // æ ¹æ®æ–‡ä»¶åç¡®å®šæ­£ç¡®çš„æ–‡ä»¶å¤¹è·¯å¾„
            const folder = filename.includes('domain') ? 'domain_expiry' : 'subscription_services';
            return `${protocol}//${domain}${port}/${folder}/${filename}`;
        }

        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½æ•°æ®å¹¶æ¸²æŸ“
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // åŠ è½½åŸŸåé…ç½®
                const domainConfig = await loadYamlFile('domain_expiry/domain_expiry.yaml');
                renderDomainTable(domainConfig);

                // åŠ è½½è®¢é˜…æœåŠ¡é…ç½®
                const subscriptionConfig = await loadYamlFile('subscription_services/subscription_services.yaml');
                renderSubscriptionTable(subscriptionConfig);

                // è®¾ç½® ICS URL
                document.getElementById('domainIcsUrl').value = getIcsUrl('domain_expiry_calendar.ics');
                document.getElementById('subscriptionIcsUrl').value = getIcsUrl('subscription_services_calendar.ics');
            } catch (error) {
                console.error('Error loading data:', error);
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                document.getElementById('domainTableBody').innerHTML = 
                    '<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">åŠ è½½æ•°æ®å¤±è´¥</td></tr>';
                document.getElementById('subscriptionTableBody').innerHTML = 
                    '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">åŠ è½½æ•°æ®å¤±è´¥</td></tr>';
            }
        });
    </script>
</body>
</html> 